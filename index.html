<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview - LPR-16 Curitiba</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
/* Cores e estilos Shopee */
.accent-shopee { background-color: #FF5C00; }
.accent-shopee:hover { background-color: #E04E00; }
.text-shopee { color: #FF5C00; }
.border-shopee { border-color: #FF5C00; }
/* Estilos base Dark Mode */
body {
font-family: 'Inter', sans-serif;
background-color: #0d131f;
color: #e5e7eb;
}
.kpi-grid {
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}
/* Ajuste para 4 colunas em telas grandes (Ger√™ncia) */
@media (min-width: 1280px) {
.kpi-grid {
grid-template-columns: repeat(4, 1fr);
}
}
.card {
transition: all 0.3s ease;
border: 1px solid rgba(255, 255, 255, 0.1);
background-color: #1f2937;
}
.card:hover {
transform: translateY(-2px);
box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
}
input[type="date"], input[type="number"], select, textarea {
background-color: #374151 !important;
border-color: #4b5563 !important;
color: #f3f4f6 !important;
}
.tab-button.active {
border-color: #FF5C00;
color: #FF5C00;
background-color: #1f2937;
}
</style>
</head>
<body class="p-4 md:p-8">
<header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center p-6 bg-gray-800 rounded-xl shadow-2xl">
<div>
<h1 class="text-3xl font-extrabold text-shopee">Overview - LPR-16 Curitiba</h1>
<p id="current-user-id" class="text-sm text-gray-400 mt-1">‚úÖ Dashboard Gerencial com Hist√≥rico Funcional</p>
</div>
<button id="open-modal-btn" class="mt-4 md:mt-0 px-6 py-2 accent-shopee text-white font-semibold rounded-lg shadow-md transition duration-300">Inserir/Editar Dados</button>
</header>

<div class="bg-gray-800 rounded-xl shadow-2xl p-6">
<div class="border-b border-gray-700 mb-6">
<nav class="-mb-px flex space-x-8 overflow-x-auto pb-2" aria-label="Tabs">
<button
id="tab-dashboard"
class="tab-button active whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150 ease-in-out border-shopee text-shopee"
data-tab-target="dashboard-content"
data-area-type="dashboard"
>üìà OVERVIEW (Resumo Geral)</button>
<button
id="tab-inventory"
class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150 ease-in-out border-transparent text-gray-400 hover:text-shopee hover:border-shopee"
data-tab-target="inventory-content"
data-area-type="Invent√°rio"
>üì¶ INVENT√ÅRIO (Hist√≥rico)</button>
<button
id="tab-reverse"
class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm transition duration-150 ease-in-out border-transparent text-gray-400 hover:text-shopee hover:border-shopee"
data-tab-target="reverse-content"
data-area-type="Reversa"
>üîÅ REVERSA (Hist√≥rico)</button>
</nav>
</div>

<div id="dashboard-content" class="tab-content">
<h2 class="text-2xl font-bold text-gray-100 mb-6">Indicadores Chave (KPIs) - Vis√£o Completa</h2>

<div class="flex flex-col md:flex-row gap-4 mb-8 items-center bg-gray-700 p-4 rounded-lg">
<label for="start-date" class="font-medium text-gray-300">Analisar per√≠odo de:</label>
<input type="date" id="start-date" class="p-2 border rounded-lg focus:ring-shopee focus:border-shopee w-full md:w-auto">
<label for="end-date" class="font-medium text-gray-300">At√©:</label>
<input type="date" id="end-date" class="p-2 border rounded-lg focus:ring-shopee focus:border-shopee w-full md:w-auto">
<button id="filter-btn-dashboard" class="px-6 py-2 accent-shopee text-white font-semibold rounded-lg shadow-md transition duration-300 w-full md:w-auto">Filtrar Dados e Gr√°ficos</button>
</div>

<div id="kpi-dashboard-container" class="grid gap-6 kpi-grid mb-10">
<p class="text-gray-400">Carregando KPIs de resumo...</p>
</div>

<h2 class="text-2xl font-bold text-gray-100 mb-6 mt-10">An√°lise de Tend√™ncia e Distribui√ß√£o</h2>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
<div class="bg-gray-700 p-4 rounded-lg shadow-inner min-h-[300px] flex flex-col">
<h3 class="text-lg font-semibold mb-2 text-shopee">1. Erros por Sorting (Dia) - Invent√°rio</h3>
<div class="flex-grow relative"><canvas id="sortingChart"></canvas></div>
</div>
<div class="bg-gray-700 p-4 rounded-lg shadow-inner min-h-[300px] flex flex-col">
<h3 class="text-lg font-semibold mb-2 text-shopee">2. Desvios de Expedi√ß√£o - Invent√°rio</h3>
<div class="flex-grow relative"><canvas id="desviosChart"></canvas></div>
</div>
<div class="bg-gray-700 p-4 rounded-lg shadow-inner min-h-[300px] flex flex-col">
<h3 class="text-lg font-semibold mb-2 text-shopee">3. Insucessos Recebidos - Reversa</h3>
<div class="flex-grow relative"><canvas id="insucessosChart"></canvas></div>
</div>
<div class="bg-gray-700 p-4 rounded-lg shadow-inner min-h-[300px] flex flex-col">
<h3 class="text-lg font-semibold mb-2 text-shopee">4. Backlog Invent√°rio (Progress√£o)</h3>
<div class="flex-grow relative"><canvas id="backlogChart"></canvas></div>
</div>
</div>
</div>

<div id="inventory-content" class="tab-content hidden">
<h2 class="text-2xl font-bold text-gray-100 mb-4">üì¶ Hist√≥rico de Registros de Invent√°rio</h2>
<p class="mb-4 text-gray-400">Clique em "Inserir/Editar Dados" para adicionar um novo registro, ou clique em um registro abaixo para editar/excluir.</p>
<div id="inventory-records-list" class="space-y-3">
<p class="text-gray-400">Nenhum registro encontrado.</p>
</div>
</div>

<div id="reverse-content" class="tab-content hidden">
<h2 class="text-2xl font-bold text-gray-100 mb-4">üîÅ Hist√≥rico de Registros de Reversa</h2>
<p class="mb-4 text-gray-400">Clique em "Inserir/Editar Dados" para adicionar um novo registro, ou clique em um registro abaixo para editar/excluir.</p>
<div id="reverse-records-list" class="space-y-3">
<p class="text-gray-400">Nenhum registro encontrado.</p>
</div>
</div>
</div>

<div id="data-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 hidden items-center justify-center p-4">
<div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
<h3 class="text-2xl font-bold mb-6 text-shopee" id="modal-title">Inserir Dados Di√°rios</h3>
<button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>

<div id="area-selection" class="mb-6 p-4 border border-gray-700 rounded-lg">
<label for="input-area" class="block text-sm font-medium text-gray-300 mb-2">Selecione a √Årea de Registro:</label>
<select id="input-area" class="block w-full p-3 border rounded-lg focus:ring-shopee focus:border-shopee">
<option value="Invent√°rio">üì¶ Invent√°rio</option>
<option value="Reversa">üîÅ Reversa</option>
</select>
</div>

<form id="daily-data-form" class="space-y-4">
<div class="w-full">
<label for="input-date" class="block text-sm font-medium text-gray-300">Data do Registro</label>
<input type="date" id="input-date" required class="mt-1 block w-full p-3 border rounded-lg shadow-sm focus:ring-shopee focus:border-shopee">
</div>

<div id="dynamic-fields-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

<div class="col-span-1 md:col-span-2">
<label for="input-observacoes" class="block text-sm font-medium text-gray-300">Observa√ß√µes (Campo Livre)</label>
<textarea id="input-observacoes" rows="2" class="mt-1 block w-full p-3 border rounded-lg focus:ring-shopee focus:border-shopee"></textarea>
</div>

<div id="calculation-results" class="col-span-1 md:col-span-2 p-4 bg-gray-700 rounded-lg hidden">
<p class="font-semibold text-gray-200 mb-1" id="calc-result-1-title"></p>
<p class="font-bold text-xl text-green-400" id="calc-result-1-value"></p>
<p class="font-semibold text-gray-200 mt-3 mb-1" id="calc-result-2-title"></p>
<p class="font-bold text-xl text-red-400" id="calc-result-2-value"></p>
</div>

<div class="mt-6 col-span-1 md:col-span-2">
<button type="submit" id="save-data-btn" class="w-full py-3 accent-shopee text-white font-bold rounded-lg shadow-lg transition duration-300">Salvar Dados</button>
</div>
</form>
</div>
</div>

<div id="system-message" class="fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-lg shadow-xl hidden" role="alert"></div>
<div id="custom-confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 hidden items-center justify-center p-4"></div>

<script>
// --- DADOS DE EXEMPLO (MOCK DATA) AGORA VAZIOS ---
const MOCK_INVENTORY_DATA = [];
const MOCK_REVERSE_DATA = [];

// --- Mapeamento de Campos ---
const INVENTORY_FIELDS = [
{ key: 'sobraDeMotoAM', label: 'Sobra de Moto (AM)', type: 'Quantidade', group: 'sobra' },
{ key: 'sobraDeMotoPM', label: 'Sobra de Moto (PM)', type: 'Quantidade', group: 'sobra' },
{ key: 'sobraDeCarroAM', label: 'Sobra de Carro (AM)', type: 'Quantidade', group: 'sobra' },
{ key: 'sobraDeCarroPM', label: 'Sobra de Carro (PM)', type: 'Quantidade', group: 'sobra' },
{ key: 'erroEtiquetaAM', label: 'Erros Etiqueta Errada (AM)', type: 'Erros', group: 'erro' },
{ key: 'erroEtiquetaPM', label: 'Erros Etiqueta Errada (PM)', type: 'Erros', group: 'erro' },
{ key: 'erroSortingAM', label: 'Erros Erro Sorting (AM)', type: 'Erros', group: 'erro' },
{ key: 'erroSortingPM', label: 'Erros Erro Sorting (PM)', type: 'Erros', group: 'erro' },
{ key: 'pacotesEHA_AM', label: 'Controle Pacotes EHA (AM)', type: 'Controle', group: 'volume' },
{ key: 'pacotesEHA_PM', label: 'Controle Pacotes EHA (PM)', type: 'Controle', group: 'volume' },
{ key: 'backlogGoleiro', label: 'Controle Backlog Goleiro AM / PM', type: 'Controle', group: 'volume' },
{ key: 'volumosos', label: 'Controle Volumosos', type: 'Controle', group: 'volume' },
{ key: 'totalAvariadosRecebidosAM', label: 'Avariados Recebidos (AM)', type: 'Avarias', group: 'avaria' },
{ key: 'totalAvariadosRecebidosPM', label: 'Avariados Recebidos (PM)', type: 'Avarias', group: 'avaria' },
{ key: 'avariadosHUB', label: 'Pacotes Avariados HUB', type: 'Avarias', group: 'avaria' },
{ key: 'avariadosSOC', label: 'Pacotes Avariados SOC', type: 'Avarias', group: 'avaria' },
{ key: 'pacotesRecuperados', label: 'Pacotes Recuperados (Salvamento)', type: 'Avarias', group: 'avaria' },
{ key: 'backlogInventario', label: 'Backlog (Pend√™ncias)', type: 'Pend√™ncias', group: 'backlog' },
{ key: 'desviosExpedicao', label: 'Cr√≠tico Desvios de Expedi√ß√£o', type: 'Cr√≠tico', group: 'erro' }
];

const REVERSE_FIELDS = [
{ key: 'insucessosRecebidos', label: 'Controle Insucessos Recebidos', type: 'Controle', group: 'volume' },
{ key: 'pacotesReetiquetados', label: 'Reprocessamento Pacotes Reetiquetados', type: 'Reprocessamento', group: 'volume' },
{ key: 'retornosEnviados', label: 'Sa√≠das Retornos Enviados', type: 'Sa√≠das', group: 'saida' },
{ key: 'misortingEnviados', label: 'Sa√≠das Misorting Enviados', type: 'Sa√≠das', group: 'saida' },
{ key: 'liquidatingEnviados', label: 'Sa√≠das Liquidating Enviados', type: 'Sa√≠das', group: 'saida' },
{ key: 'semIdentificacaoEnviados', label: 'Sa√≠das Sem Identifica√ß√£o Enviados', type: 'Sa√≠das', group: 'saida' },
{ key: 'lhsRecebidas', label: 'Recebimento LH‚Äôs Recebidas (carretas)', type: 'Recebimento', group: 'volume' },
{ key: 'totalPacotesDescarregados', label: 'Quantitativo Total Pacotes Descarregados', type: 'Quantitativo', group: 'volume' },
{ key: 'pacotesVoandoRev', label: 'Anomalias Pacotes Voando (sem rastreio)', type: 'Anomalias', group: 'anomalia' },
{ key: 'lhsCarregadas', label: 'Sa√≠das LH‚Äôs Carregadas (Pallets / Sacas / Papel√£o)', type: 'Sa√≠das', group: 'saida' },
];

let allMetrics = { Invent√°rio: [], Reversa: [] };
let chartInstances = {};

// --- Fun√ß√µes de Inicializa√ß√£o e C√°lculo ---
function calculateInventario(data) {
const totalEHA = (data.pacotesEHA_AM || 0) + (data.pacotesEHA_PM || 0);
const totalSorting = (data.erroSortingAM || 0) + (data.erroSortingPM || 0);
const totalAvarias = (data.totalAvariadosRecebidosAM || 0) + (data.totalAvariadosRecebidosPM || 0);
const totalErroEtiqueta = (data.erroEtiquetaAM || 0) + (data.erroEtiquetaPM || 0);

return { totalEHA, totalSorting, totalAvarias, totalErroEtiqueta };
}

function calculateReversa(data) {
return {};
}

function processMockData(area, mockData) {
return mockData.map(data => {
if (area === 'Invent√°rio') {
return { ...data, ...calculateInventario(data) };
} else if (area === 'Reversa') {
return { ...data, ...calculateReversa(data) };
}
return data;
});
}

function saveDataToStorage(area, data) {
let areaMetrics = allMetrics[area];
const index = areaMetrics.findIndex(m => m.date === data.date);
let finalData = { ...data };

if (area === 'Invent√°rio') {
finalData = { ...finalData, ...calculateInventario(data) };
} else if (area === 'Reversa') {
finalData = { ...finalData, ...calculateReversa(data) };
}

if (index !== -1) {
areaMetrics[index] = finalData;
} else {
areaMetrics.push(finalData);
}

localStorage.setItem(`${area.toLowerCase()}_metrics_local`, JSON.stringify(areaMetrics));
allMetrics[area] = areaMetrics;
showMessage(`Dados de ${area} em ${data.date} salvos com sucesso!`);

document.getElementById('data-modal').classList.add('hidden');
document.getElementById('data-modal').classList.remove('flex');

const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
loadDashboardMetrics(start, end);
renderHistoricalRecords(area === 'Invent√°rio' ? 'inventory-records-list' : 'reverse-records-list', area, areaMetrics);
}

function deleteDataFromStorage(area, date) {
let areaMetrics = allMetrics[area];
areaMetrics = areaMetrics.filter(m => m.date !== date);

localStorage.setItem(`${area.toLowerCase()}_metrics_local`, JSON.stringify(areaMetrics));
allMetrics[area] = areaMetrics;

showMessage(`Registro de ${area} em ${date} exclu√≠do com sucesso!`);

const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
loadDashboardMetrics(start, end);
renderHistoricalRecords(area === 'Invent√°rio' ? 'inventory-records-list' : 'reverse-records-list', area, areaMetrics);
}

// --- Fun√ß√µes de UI (sem altera√ß√£o) ---
function showMessage(message, isError = false) {
const el = document.getElementById('system-message');
el.textContent = message;
el.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
el.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
setTimeout(() => el.classList.add('hidden'), 5000);
}

function formatDate(date) {
return date instanceof Date ? date.toISOString().split('T')[0] : date;
}

function showCustomConfirmation(message, onConfirm) {
let modalConfirmation = document.getElementById('custom-confirmation-modal');
modalConfirmation.classList.remove('hidden');
modalConfirmation.classList.add('flex');
modalConfirmation.innerHTML = `<div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full"><h5 class="text-lg font-bold mb-4 text-shopee">Confirma√ß√£o de A√ß√£o</h5><p class="mb-6 text-gray-300">${message}</p><div class="flex justify-end space-x-3"><button id="cancel-action" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Cancelar</button><button id="confirm-action" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-500">Confirmar</button></div></div>`;

const removeModal = () => {
modalConfirmation.classList.add('hidden');
modalConfirmation.classList.remove('flex');
};

document.getElementById('cancel-action').addEventListener('click', removeModal);
document.getElementById('confirm-action').addEventListener('click', () => { onConfirm(); removeModal(); });
}

function renderForm(area, initialData = {}) {
const container = document.getElementById('dynamic-fields-container');
container.innerHTML = '';
const fields = area === 'Invent√°rio' ? INVENTORY_FIELDS : REVERSE_FIELDS;

fields.forEach(field => {
const value = initialData[field.key] !== undefined ? initialData[field.key] : 0;
const div = document.createElement('div');
div.className = 'w-full';
div.innerHTML = `<label for="input-${field.key}" class="block text-sm font-medium text-gray-300">${field.label} <span class="text-xs text-gray-500">(${field.type})</span></label><input type="number" min="0" value="${value}" required class="mt-1 block w-full p-3 border rounded-lg focus:ring-shopee focus:border-shopee" data-metric-key="${field.key}">`;
container.appendChild(div);
});

document.getElementById('input-observacoes').value = initialData.observacoes || '';
updateCalculations();
}

function updateCalculations() {
const resultsContainer = document.getElementById('calculation-results');
resultsContainer.classList.add('hidden');
}

function renderHistoricalRecords(containerId, area, metrics) {
const listContainer = document.getElementById(containerId);
listContainer.innerHTML = '';
const sortedMetrics = metrics.sort((a, b) => new Date(b.date) - new Date(a.date));

if (sortedMetrics.length === 0) {
listContainer.innerHTML = '<p class="text-gray-400">Nenhum registro encontrado.</p>';
return;
}

sortedMetrics.forEach(metric => {
let mainMetricDisplay = '';
let mainMetricColor = 'text-gray-400';

if (area === 'Invent√°rio') {
const backlog = metric.backlogInventario !== undefined ? metric.backlogInventario.toLocaleString('pt-BR') : 0;
mainMetricDisplay = `Backlog: ${backlog}`;
mainMetricColor = backlog == 0 ? 'text-green-400' : 'text-yellow-400';
} else if (area === 'Reversa') {
const insucessos = metric.insucessosRecebidos !== undefined ? metric.insucessosRecebidos.toLocaleString('pt-BR') : 0;
mainMetricDisplay = `Insucessos: ${insucessos}`;
mainMetricColor = 'text-blue-400';
}

const div = document.createElement('div');
div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center p-3 card rounded-lg border border-gray-600';
div.innerHTML = `<div class="mb-2 sm:mb-0"><span class="font-semibold text-gray-200">${metric.date}</span><span class="ml-4 ${mainMetricColor} font-bold">${mainMetricDisplay}</span></div><div class="space-x-2 flex"><button data-date="${metric.date}" data-area="${area}" class="edit-btn text-shopee hover:text-orange-400 font-medium">Editar</button><button data-date="${metric.date}" data-area="${area}" class="delete-btn text-red-400 hover:text-red-300 font-medium">Excluir</button></div>`;
listContainer.appendChild(div);
});

// Adicionando event listeners ap√≥s a renderiza√ß√£o
listContainer.querySelectorAll('.edit-btn').forEach(button => {
button.addEventListener('click', (e) => editRecord(e.target.dataset.area, e.target.dataset.date));
});

listContainer.querySelectorAll('.delete-btn').forEach(button => {
button.addEventListener('click', (e) => {
const area = e.target.dataset.area;
const date = e.target.dataset.date;
showCustomConfirmation(`Tem certeza que deseja EXCLUIR o registro de ${area} em ${date}?`, () => deleteDataFromStorage(area, date));
});
});
}

function editRecord(area, date) {
const record = allMetrics[area].find(m => m.date === date);
if (!record) { showMessage(`Registro de ${area} em ${date} n√£o encontrado.`, true); return; }

document.getElementById('modal-title').textContent = `Editando Dados de ${area} em ${date}`;
document.getElementById('input-area').value = area;
document.getElementById('input-area').disabled = true;
document.getElementById('input-date').value = date;
renderForm(area, record);
openDataModal(area, record);
}

function openDataModal(area = 'Invent√°rio', data = {}) {
if (!data.date) {
document.getElementById('modal-title').textContent = 'Inserir Dados Di√°rios';
document.getElementById('input-area').disabled = false;
document.getElementById('input-area').value = area;
document.getElementById('input-date').value = formatDate(new Date());
} else {
document.getElementById('input-area').disabled = true;
}
renderForm(area, data);
document.getElementById('data-modal').classList.remove('hidden');
document.getElementById('data-modal').classList.add('flex');
}

function switchTab(targetId) {
document.querySelectorAll('.tab-content').forEach(content => { content.classList.add('hidden'); });
document.getElementById(targetId).classList.remove('hidden');

document.querySelectorAll('.tab-button').forEach(button => {
button.classList.remove('active', 'border-shopee', 'text-shopee');
button.classList.add('border-transparent', 'text-gray-400', 'hover:text-shopee', 'hover:border-shopee');
});

const activeBtn = document.querySelector(`[data-tab-target="${targetId}"]`);
if (activeBtn) {
activeBtn.classList.add('active', 'border-shopee', 'text-shopee');
activeBtn.classList.remove('border-transparent', 'text-gray-400', 'hover:text-shopee', 'hover:border-shopee');
}

if (targetId === 'dashboard-content') {
const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
loadDashboardMetrics(start, end);
}
}

function loadDashboardMetrics(startDate, endDate) {
const inventarioMetrics = allMetrics.Invent√°rio.filter(m => m.date >= startDate && m.date <= endDate);
const reversaMetrics = allMetrics.Reversa.filter(m => m.date >= startDate && m.date <= endDate);

calculateAndRenderKPIs(inventarioMetrics, reversaMetrics);
renderDashboardCharts(inventarioMetrics, reversaMetrics);
}

// --- FUN√á√ÉO KPI's (sem altera√ß√£o) ---
function calculateAndRenderKPIs(inventarioMetrics, reversaMetrics) {
const container = document.getElementById('kpi-dashboard-container');
container.innerHTML = '';

// --- C√ÅLCULOS DE INVENT√ÅRIO ---
const totalDesvios = inventarioMetrics.reduce((sum, m) => sum + (m.desviosExpedicao || 0), 0);

// Totais para detalhamento AM/PM
const totalEHA = inventarioMetrics.reduce((sum, m) => sum + (m.pacotesEHA_AM || 0) + (m.pacotesEHA_PM || 0), 0);
const totalSortingErros = inventarioMetrics.reduce((sum, m) => sum + (m.erroSortingAM || 0) + (m.erroSortingPM || 0), 0);
const totalAvariadosRecebidos = inventarioMetrics.reduce((sum, m) => sum + (m.totalAvariadosRecebidosAM || 0) + (m.totalAvariadosRecebidosPM || 0), 0);
const totalErroEtiqueta = inventarioMetrics.reduce((sum, m) => sum + (m.erroEtiquetaAM || 0) + (m.erroEtiquetaPM || 0), 0);

const totalAvariadosHUB = inventarioMetrics.reduce((sum, m) => sum + (m.avariadosHUB || 0), 0);
const totalAvariadosSOC = inventarioMetrics.reduce((sum, m) => sum + (m.avariadosSOC || 0), 0);
const totalPacotesRecuperados = inventarioMetrics.reduce((sum, m) => sum + (m.pacotesRecuperados || 0), 0);

const latestInventarioBacklog = inventarioMetrics.length > 0 ? inventarioMetrics.sort((a, b) => new Date(b.date) - new Date(a.date))[0].backlogInventario || 0 : 0;


// FUN√á√ïES PARA DETALHE AM/PM
const detailEHA = inventarioMetrics.length > 0 ?
`(${inventarioMetrics.reduce((sum, m) => sum + (m.pacotesEHA_AM || 0), 0).toLocaleString('pt-BR')} AM / ${inventarioMetrics.reduce((sum, m) => sum + (m.pacotesEHA_PM || 0), 0).toLocaleString('pt-BR')} PM)` : '';

const detailSorting = inventarioMetrics.length > 0 ?
`(${inventarioMetrics.reduce((sum, m) => sum + (m.erroSortingAM || 0), 0).toLocaleString('pt-BR')} AM / ${inventarioMetrics.reduce((sum, m) => sum + (m.erroSortingPM || 0), 0).toLocaleString('pt-BR')} PM)` : '';

const detailAvarias = inventarioMetrics.length > 0 ?
`(${inventarioMetrics.reduce((sum, m) => sum + (m.totalAvariadosRecebidosAM || 0), 0).toLocaleString('pt-BR')} AM / ${inventarioMetrics.reduce((sum, m) => sum + (m.totalAvariadosRecebidosPM || 0), 0).toLocaleString('pt-BR')} PM)` : '';

const detailErroEtiqueta = inventarioMetrics.length > 0 ?
`(${inventarioMetrics.reduce((sum, m) => sum + (m.erroEtiquetaAM || 0), 0).toLocaleString('pt-BR')} AM / ${inventarioMetrics.reduce((sum, m) => sum + (m.erroEtiquetaPM || 0), 0).toLocaleString('pt-BR')} PM)` : '';


// --- C√ÅLCULOS DE REVERSA ---
const totalInsucessos = reversaMetrics.reduce((sum, m) => sum + (m.insucessosRecebidos || 0), 0);
const totalLHsRecebidas = reversaMetrics.reduce((sum, m) => sum + (m.lhsRecebidas || 0), 0);
const totalPacotesDescarregados = reversaMetrics.reduce((sum, m) => sum + (m.totalPacotesDescarregados || 0), 0);
const avgPacotesPorLH = totalLHsRecebidas > 0 ? (totalPacotesDescarregados / totalLHsRecebidas) : 0;

// --- DEFINI√á√ÉO DOS KPIS ---
const kpis = [
// 1. INVENT√ÅRIO (VOLUME & ERROS CR√çTICOS)
{ name: 'Pacotes EHA (Entrada)', value: totalEHA.toLocaleString('pt-BR'), detail: detailEHA, color: 'bg-blue-700', sub: 'Invent√°rio - Volume Base' },
{ name: 'Sorting Erros (Per√≠odo)', value: totalSortingErros.toLocaleString('pt-BR'), detail: detailSorting, color: 'bg-red-700', sub: 'Invent√°rio - Erro Classifica√ß√£o' },
{ name: 'Erros Etiqueta Errada', value: totalErroEtiqueta.toLocaleString('pt-BR'), detail: detailErroEtiqueta, color: 'bg-red-700', sub: 'Invent√°rio - Erro Etiqueta' },
{ name: 'Desvios Expedi√ß√£o', value: totalDesvios.toLocaleString('pt-BR'), detail: '', color: 'bg-red-700', sub: 'Invent√°rio - Cr√≠tico' },
{ name: 'Backlog (Invent√°rio)', value: latestInventarioBacklog.toLocaleString('pt-BR'), detail: '', color: latestInventarioBacklog > 0 ? 'accent-shopee' : 'bg-green-600', sub: 'Invent√°rio - Status Atual' },

// 2. REVERSA (STATUS & VOLUME)
{ name: 'Insucessos Recebidos', value: totalInsucessos.toLocaleString('pt-BR'), detail: '', color: 'bg-indigo-600', sub: 'Reversa - Volume Processado' },
{ name: 'LH‚Äôs Recebidas', value: totalLHsRecebidas.toLocaleString('pt-BR'), detail: '', color: 'bg-gray-600', sub: 'Reversa - Entrada Carretas' },
{ name: 'Pacotes Descarregados', value: totalPacotesDescarregados.toLocaleString('pt-BR'), detail: '', color: 'bg-gray-600', sub: 'Reversa - Volume por LH' },
{ name: 'Pacotes / LH (M√©dia)', value: avgPacotesPorLH.toFixed(0).toLocaleString('pt-BR'), detail: '', color: 'bg-gray-600', sub: 'Reversa - M√©dia por Carreta' },

// 3. INVENT√ÅRIO (AVARIAS E RECUPERA√á√ÉO)
{ name: 'Avariados Recebidos', value: totalAvariadosRecebidos.toLocaleString('pt-BR'), detail: detailAvarias, color: 'bg-yellow-700', sub: 'Invent√°rio - Total de Avarias' },
{ name: 'Avariados HUB (Responsabilidade)', value: totalAvariadosHUB.toLocaleString('pt-BR'), detail: '', color: 'bg-red-800', sub: 'Invent√°rio - HUB Share' },
{ name: 'Avariados SOC (Responsabilidade)', value: totalAvariadosSOC.toLocaleString('pt-BR'), detail: '', color: 'bg-red-800', sub: 'Invent√°rio - SOC Share' },
{ name: 'Pacotes Recuperados (Salvamento)', value: totalPacotesRecuperados.toLocaleString('pt-BR'), detail: '', color: 'bg-green-700', sub: 'Invent√°rio - Volume Salvo' }
];

// Renderiza os KPIs
container.style.gridTemplateColumns = `repeat(${Math.min(kpis.length, 5)}, 1fr)`; // Ajusta o grid para 5 colunas se houver mais de 5 KPIs

kpis.forEach(kpi => {
const card = document.createElement('div');
card.className = `card ${kpi.color} p-5 rounded-xl shadow-lg flex flex-col justify-between`;
card.innerHTML = `
<p class="text-sm font-medium opacity-90">${kpi.name}</p>
<p class="text-xs text-gray-200 mt-1 mb-2">${kpi.sub}</p>
<p class="text-4xl font-bold text-white">${kpi.value}</p>
${kpi.detail ? `<p class="text-xs text-white opacity-70 mt-1">${kpi.detail}</p>` : ''}
`;
container.appendChild(card);
});
}

// --- FUN√á√ÉO CHART ATUALIZADA (Adiciona o Gr√°fico de Backlog Invent√°rio) ---
function renderDashboardCharts(inventarioMetrics, reversaMetrics) {
Object.values(chartInstances).forEach(instance => instance.destroy());
chartInstances = {};

const chartGlobalOptions = {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { labels: { color: '#e5e7eb' } }
},
scales: {
x: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, beginAtZero: true }
}
};

const sortedInv = inventarioMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));
const sortedRev = reversaMetrics.sort((a, b) => new Date(a.date) - new Date(b.date));

// GR√ÅFICO 1: Erros Sorting
const ctx1 = document.getElementById('sortingChart')?.getContext('2d');
if (ctx1) {
chartInstances.sortingChart = new Chart(ctx1, {
type: 'line',
data: {
labels: sortedInv.map(m => m.date),
datasets: [{
label: 'Erros Sorting (AM + PM)',
data: sortedInv.map(m => m.totalSorting),
borderColor: '#FF5C00',
backgroundColor: 'rgba(255, 92, 0, 0.3)',
fill: true,
tension: 0.4
}]
},
options: chartGlobalOptions
});
}

// GR√ÅFICO 2: Desvios
const ctx2 = document.getElementById('desviosChart')?.getContext('2d');
if (ctx2) {
chartInstances.desviosChart = new Chart(ctx2, {
type: 'bar',
data: {
labels: sortedInv.map(m => m.date),
datasets: [{
label: 'Desvios de Expedi√ß√£o',
data: sortedInv.map(m => m.desviosExpedicao),
backgroundColor: '#dc2626'
}]
},
options: chartGlobalOptions
});
}

// GR√ÅFICO 3: Insucessos Reversa
const ctx3 = document.getElementById('insucessosChart')?.getContext('2d');
if (ctx3) {
chartInstances.insucessosChart = new Chart(ctx3, {
type: 'line',
data: {
labels: sortedRev.map(m => m.date),
datasets: [{
label: 'Insucessos Recebidos',
data: sortedRev.map(m => m.insucessosRecebidos),
borderColor: '#818cf8',
backgroundColor: 'rgba(129, 140, 248, 0.3)',
fill: true,
tension: 0.4
}]
},
options: chartGlobalOptions
});
}

// GR√ÅFICO 4: Backlog Invent√°rio (Progress√£o) - NOVO
const ctx4 = document.getElementById('backlogChart')?.getContext('2d');
if (ctx4) {
// Remove o par√°grafo de placeholder se existir (embora o HTML tenha sido limpo)
document.querySelector('#backlogChart').closest('.flex-col').querySelector('p')?.remove();

chartInstances.backlogChart = new Chart(ctx4, {
type: 'line',
data: {
labels: sortedInv.map(m => m.date),
datasets: [{
label: 'Backlog Invent√°rio (Pend√™ncias)',
data: sortedInv.map(m => m.backlogInventario),
borderColor: '#FF5C00',
backgroundColor: 'rgba(255, 92, 0, 0.3)',
fill: true,
tension: 0.4
}]
},
options: chartGlobalOptions
});
}
}

// --- Fun√ß√£o de Inicializa√ß√£o principal ---
function initApp() {
let invData = localStorage.getItem('inventory_metrics_local');
let revData = localStorage.getItem('reverse_metrics_local');

allMetrics.Invent√°rio = invData ? JSON.parse(invData) : [];
allMetrics.Reversa = revData ? JSON.parse(revData) : [];

// Garante que todos os dados tenham os campos calculados atualizados
allMetrics.Invent√°rio = allMetrics.Invent√°rio.map(m => ({ ...m, ...calculateInventario(m) }));
allMetrics.Reversa = allMetrics.Reversa.map(m => ({ ...m, ...calculateReversa(m) }));

const today = formatDate(new Date());
const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

document.getElementById('start-date').value = formatDate(firstDayOfMonth);
document.getElementById('end-date').value = today;

loadDashboardMetrics(formatDate(firstDayOfMonth), today);
renderHistoricalRecords('inventory-records-list', 'Invent√°rio', allMetrics.Invent√°rio);
renderHistoricalRecords('reverse-records-list', 'Reversa', allMetrics.Reversa);

setupListeners();
}

function setupListeners() {
document.getElementById('filter-btn-dashboard').addEventListener('click', () => {
const start = document.getElementById('start-date').value;
const end = document.getElementById('end-date').value;
loadDashboardMetrics(start, end);
});

document.querySelectorAll('.tab-button').forEach(button => {
button.addEventListener('click', (e) => switchTab(e.target.dataset.tabTarget));
});

document.getElementById('open-modal-btn').addEventListener('click', () => openDataModal());

document.getElementById('close-modal-btn').addEventListener('click', () => {
document.getElementById('data-modal').classList.add('hidden');
document.getElementById('data-modal').classList.remove('flex');
});

document.getElementById('input-area').addEventListener('change', (e) => renderForm(e.target.value, {}));

document.getElementById('daily-data-form').addEventListener('submit', (e) => {
e.preventDefault();
const area = document.getElementById('input-area').value;
const data = {
date: document.getElementById('input-date').value,
observacoes: document.getElementById('input-observacoes').value
};

document.querySelectorAll('#dynamic-fields-container input[data-metric-key]').forEach(input => {
data[input.dataset.metricKey] = parseInt(input.value || '0', 10);
});
saveDataToStorage(area, data);
});

document.getElementById('dynamic-fields-container').addEventListener('input', updateCalculations);
}

// Iniciar App quando a janela carregar.
window.onload = initApp;
</script>
</body>
</html>
