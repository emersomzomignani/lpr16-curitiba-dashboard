// Apps Script - Cole isto no arquivo Code.gs
function doGet(e) {
  var area = e.parameter.area;
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();

  // Se nenhuma área for especificada, retorna todos os dados.
  if (area) {
    var sheet = spreadsheet.getSheetByName(area);
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Aba não encontrada: ' + area })).setMimeType(ContentService.MimeType.JSON);
    }
    return getSheetData(sheet);
  } else {
    // Retorna todos os dados para o dashboard principal
    var invSheet = spreadsheet.getSheetByName('Inventário');
    var revSheet = spreadsheet.getSheetByName('Reversa');

    var allData = {};
    if (invSheet) {
      allData.Inventário = getSheetData(invSheet).data;
    }
    if (revSheet) {
      allData.Reversa = getSheetData(revSheet).data;
    }

    return ContentService.createTextOutput(JSON.stringify({ status: 'success', data: allData })).setMimeType(ContentService.MimeType.JSON);
  }
}

function getSheetData(sheet) {
  var dataRange = sheet.getDataRange();
  var values = dataRange.getValues();

  if (values.length === 0) {
    return { status: 'success', data: [] };
  }

  var headers = values[0];
  var data = [];

  for (var i = 1; i < values.length; i++) {
    var row = values[i];
    var record = {};
    for (var j = 0; j < headers.length; j++) {
      var key = headers[j];
      var value = row[j];

      // Converte Datas para o formato YYYY-MM-DD
      if (value instanceof Date) {
        value = Utilities.formatDate(value, Session.getScriptTimeZone(), 'yyyy-MM-dd');
      }

      // Tenta converter métricas numéricas
      if (typeof value === 'number' || (typeof value === 'string' && !isNaN(value) && key !== 'observacoes' && key !== 'area')) {
         record[key] = parseFloat(value);
      } else {
         record[key] = value;
      }
    }
    data.push(record);
  }

  return { status: 'success', data: data };
}

function doPost(e) {
  var data = e.parameter;
  var area = data.area;
  var date = data.date;

  if (!area || !date) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Área e Data são obrigatórios.' })).setMimeType(ContentService.MimeType.JSON);
  }

  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = spreadsheet.getSheetByName(area);

  if (!sheet) {
    // Cria a aba se ela não existir
    sheet = spreadsheet.insertSheet(area);
  }

  // A primeira linha (cabeçalho)
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  var newRow = [];

  // Se a aba estiver vazia, cria o cabeçalho
  if (sheet.getLastRow() < 1 || headers.join('') === '') {
    var allKeys = Object.keys(data);

    // Filtra 'area' do cabeçalho
    var defaultHeaders = allKeys.filter(key => key !== 'area');
    sheet.appendRow(defaultHeaders);
    headers = defaultHeaders;

    // Re-leitura dos valores após criação do cabeçalho
    for (var i = 0; i < headers.length; i++) {
      newRow.push(data[headers[i]] || 0); // Usa 0 se valor não existir
    }
  } else {
    // Se o cabeçalho existe, preenche a linha seguindo a ordem do cabeçalho
    for (var i = 0; i < headers.length; i++) {
      var headerKey = headers[i];
      // Tenta encontrar o valor enviado pelo formulário, usando 0 como fallback
      newRow.push(data[headerKey] || 0);
    }
  }

  sheet.appendRow(newRow);

  return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'Dados de ' + area + ' salvos com sucesso na Planilha.' })).setMimeType(ContentService.MimeType.JSON);
}
