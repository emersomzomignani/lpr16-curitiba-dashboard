<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPR-16: Dashboard Gerencial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        /* Estilos personalizados para a dashboard */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f9;
        }
        .kpi-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        .metric-title {
            color: #4a5568;
        }
        .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
        }
        .bg-inventory { background-color: #4CAF50; } /* Verde */
        .bg-reverse { background-color: #F44336; } /* Vermelho */
        .bg-service-level { background-color: #2196F3; } /* Azul */
        .bg-logistics { background-color: #FF9800; } /* Laranja */
        .bg-general { background-color: #673AB7; } /* Roxo */
        
        /* Estilo para o modal (fora do Tailwind para garantir sobreposição) */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <div id="message-container" class="fixed bottom-4 right-4 z-50"></div>

    <div id="data-modal" class="modal fixed inset-0 hidden items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full lg:w-1/3">
            <h2 class="text-xl font-bold mb-4">Inserir/Editar Dados Diários</h2>
            <form id="daily-data-form" class="space-y-4">
                <div>
                    <label for="input-area" class="block text-sm font-medium text-gray-700">Área (Obrigatório):</label>
                    <select id="input-area" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                        <option value="">Selecione a Área</option>
                        <option value="Inventario">Inventário</option>
                        <option value="Reversa">Reversa</option>
                        <option value="NivelDeServico">Nível de Serviço</option>
                        <option value="Logistica">Logística</option>
                        <option value="Geral">Geral</option>
                    </select>
                </div>
                <div>
                    <label for="input-date" class="block text-sm font-medium text-gray-700">Data (Obrigatório):</label>
                    <input type="date" id="input-date" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2">
                </div>

                <div id="dynamic-fields-container" class="space-y-3">
                    </div>

                <div>
                    <label for="input-observacoes" class="block text-sm font-medium text-gray-700">Observações:</label>
                    <textarea id="input-observacoes" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-2"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('data-modal').classList.add('hidden'); document.getElementById('data-modal').classList.remove('flex');" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Salvar Dados
                    </button>
                </div>
            </form>
        </div>
    </div>

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">LPR-16 Curitiba: Dashboard de KPIs</h1>
            <button onclick="document.getElementById('data-modal').classList.add('flex'); document.getElementById('data-modal').classList.remove('hidden'); setupModal();" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150">
                Inserir/Editar Dados
            </button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-4 bg-white shadow-md mt-4 rounded-lg">
        <h2 class="text-xl font-semibold mb-3 text-gray-700">Filtro de Período</h2>
        <div class="flex space-x-4 items-end">
            <div>
                <label for="start-date" class="block text-sm font-medium text-gray-700">De:</label>
                <input type="date" id="start-date" class="mt-1 block border-gray-300 rounded-md shadow-sm p-2 w-48" onchange="applyFilters()">
            </div>
            <div>
                <label for="end-date" class="block text-sm font-medium text-gray-700">Até:</label>
                <input type="date" id="end-date" class="mt-1 block border-gray-300 rounded-md shadow-sm p-2 w-48" onchange="applyFilters()">
            </div>
            <button onclick="resetFilters()" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition duration-150">
                Resetar Filtro
            </button>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">

        <section class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">KPIs de Hoje / Último Registro</h2>
            <div id="kpi-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                </div>
        </section>

        <section class="space-y-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Tendência de Métricas</h2>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 metric-title">Backlog de Inventário e Processos de Reversa</h3>
                <canvas id="inventoryReverseChart"></canvas>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 metric-title">Nível de Serviço: Tempo e Acuracidade</h3>
                <canvas id="serviceLevelChart"></canvas>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-xl font-bold mb-4 metric-title">Logística: Desvios e Produtividade</h3>
                <canvas id="logisticsChart"></canvas>
            </div>
        </section>

    </main>

    <footer class="text-center py-4 text-gray-500 mt-8">
        <p>© 2025 LPR-16 Curitiba Dashboard. Última atualização: <span id="last-update-time"></span></p>
    </footer>

    <script>
        // Mapeamento de Métricas e Cores
        const metricConfigs = {
            'Inventario': [
                { key: 'backlogInventario', name: 'Backlog de Inventário (Unidades)', color: 'rgba(76, 175, 80, 1)' },
                { key: 'totalSorting', name: 'Total Sorting (Unidades)', color: 'rgba(139, 195, 74, 1)' }
            ],
            'Reversa': [
                { key: 'desviosExpedicao', name: 'Desvios de Expedição', color: 'rgba(244, 67, 54, 1)' },
                { key: 'insucessosRecebidos', name: 'Insucessos Recebidos', color: 'rgba(255, 152, 0, 1)' }
            ],
            'NivelDeServico': [
                { key: 'acuracidadeInventario', name: 'Acuracidade Inventário (%)', color: 'rgba(33, 150, 243, 1)' },
                { key: 'slRecebimento', name: 'SL Recebimento (%)', color: 'rgba(103, 58, 183, 1)' },
                { key: 'slExpedicao', name: 'SL Expedição (%)', color: 'rgba(0, 188, 212, 1)' }
            ],
            'Logistica': [
                { key: 'produtividadeRecebimento', name: 'Produtividade Recebimento', color: 'rgba(255, 99, 132, 1)' },
                { key: 'produtividadeExpedicao', name: 'Produtividade Expedição', color: 'rgba(75, 192, 192, 1)' }
            ],
            'Geral': [
                { key: 'eficienciaGeral', name: 'Eficiência Geral (%)', color: 'rgba(255, 206, 86, 1)' },
            ]
        };

        // Estrutura de dados para armazenar todas as métricas
        let allMetrics = {
            'Inventario': {},
            'Reversa': {},
            'NivelDeServico': {},
            'Logistica': {},
            'Geral': {}
        };
        
        let charts = {};
        let activeFilters = {
            startDate: null,
            endDate: null
        };
        
        // Registrar o plugin datalabels
        Chart.register(ChartDataLabels);

        // --- Funções de Utilitário e Estado ---

        function showMessage(message, isError = false) {
            const container = document.getElementById('message-container');
            const messageDiv = document.createElement('div');
            
            let bgColor = isError ? 'bg-red-500' : 'bg-green-500';
            let icon = isError ? '❌' : '✅';

            messageDiv.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-3 flex items-center space-x-3 opacity-0 transition-opacity duration-300`;
            messageDiv.innerHTML = `${icon} <span class="font-semibold">${message}</span>`;
            
            container.appendChild(messageDiv);
            
            // Fading in
            setTimeout(() => {
                messageDiv.classList.remove('opacity-0');
            }, 10);

            // Fading out and removal
            setTimeout(() => {
                messageDiv.classList.add('opacity-0');
                setTimeout(() => {
                    container.removeChild(messageDiv);
                }, 500);
            }, 5000);
        }

        // --- Funções de Dados e Armazenamento ---

        function loadAllMetrics() {
            Object.keys(allMetrics).forEach(area => {
                const data = localStorage.getItem(`${area.toLowerCase()}_metrics_local`);
                if (data) {
                    allMetrics[area] = JSON.parse(data);
                }
            });
            updateLastUpdateTime();
        }

        function saveDataToStorage(area, data) {
            // Garante que o objeto para a área existe
            if (!allMetrics[area]) {
                allMetrics[area] = {};
            }

            // Remove a observação do objeto que vai para o Local Storage, mas mantém para a data
            const cleanData = { ...data };
            delete cleanData.observacoes;

            // Chave de data (ISO format: YYYY-MM-DD)
            const dateKey = data.date;

            // Atualiza o objeto de métricas
            const areaMetrics = { ...allMetrics[area], [dateKey]: data };
            
            // Salva no Local Storage
            localStorage.setItem(`${area.toLowerCase()}_metrics_local`, JSON.stringify(areaMetrics));
            
            // Atualiza o estado global
            allMetrics[area] = areaMetrics;

            // Atualiza a dashboard e fecha o modal
            renderDashboard();
            document.getElementById('data-modal').classList.add('hidden');
            document.getElementById('data-modal').classList.remove('flex');

            showMessage(`Dados de ${area} em ${data.date} salvos com sucesso!`);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR');
            document.getElementById('last-update-time').textContent = `${dateStr} às ${timeStr}`;
        }
        
        // --- Funções de Renderização e Gráficos ---

        function getFilteredMetrics() {
            const filteredMetrics = {};
            const startDate = activeFilters.startDate ? new Date(activeFilters.startDate) : null;
            const endDate = activeFilters.endDate ? new Date(activeFilters.endDate) : null;

            // Garante que o EndDate inclui o dia inteiro (até 23:59:59)
            if (endDate) {
                endDate.setDate(endDate.getDate() + 1);
            }

            Object.keys(allMetrics).forEach(area => {
                filteredMetrics[area] = {};
                
                Object.keys(allMetrics[area]).forEach(dateKey => {
                    const metricDate = new Date(dateKey + 'T00:00:00'); // Garante que a comparação é apenas por data

                    const isBeforeEnd = !endDate || metricDate < endDate;
                    const isAfterStart = !startDate || metricDate >= startDate;

                    if (isAfterStart && isBeforeEnd) {
                        filteredMetrics[area][dateKey] = allMetrics[area][dateKey];
                    }
                });
            });

            return filteredMetrics;
        }

        function getLatestMetricValue(area, key) {
            const dates = Object.keys(allMetrics[area] || {}).sort((a, b) => new Date(b) - new Date(a));
            for (const date of dates) {
                if (allMetrics[area][date] && allMetrics[area][date][key] !== undefined) {
                    return {
                        value: allMetrics[area][date][key],
                        date: date
                    };
                }
            }
            return { value: 0, date: 'N/A' };
        }

        function renderKPISummary() {
            const container = document.getElementById('kpi-summary');
            container.innerHTML = '';
            
            const kpiMap = {
                'backlogInventario': { title: 'Backlog Inv. (Unid)', area: 'Inventario', color: 'bg-inventory' },
                'desviosExpedicao': { title: 'Desvios Exp. (Unid)', area: 'Reversa', color: 'bg-reverse' },
                'acuracidadeInventario': { title: 'Acuracidade Inv. (%)', area: 'NivelDeServico', color: 'bg-service-level', format: true },
                'slExpedicao': { title: 'SL Expedição (%)', area: 'NivelDeServico', color: 'bg-service-level', format: true },
                'produtividadeExpedicao': { title: 'Prod. Expedição', area: 'Logistica', color: 'bg-logistics' }
            };

            Object.keys(kpiMap).forEach(key => {
                const config = kpiMap[key];
                const latest = getLatestMetricValue(config.area, key);
                const value = config.format ? (latest.value).toFixed(2) : latest.value.toLocaleString('pt-BR');

                const card = `
                    <div class="kpi-card ${config.color} text-white p-6 rounded-lg">
                        <p class="metric-title text-sm font-light">${config.title} (Últ. Reg: ${latest.date})</p>
                        <p class="metric-value">${value}</p>
                    </div>
                `;
                container.innerHTML += card;
            });
        }
        
        function renderChart(canvasId, title, datasets, type = 'line', options = {}) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toLocaleString('pt-BR');
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: {
                        display: false, // Desativa por padrão para não poluir
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Data'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Valor'
                        },
                        ticks: {
                            callback: function(value, index, ticks) {
                                return value.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            };
            
            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: datasets.labels,
                    datasets: datasets.datasets.map(dataset => ({
                        ...dataset,
                        borderWidth: 2,
                        pointRadius: 5,
                        fill: false
                    }))
                },
                options: { ...defaultOptions, ...options }
            });
        }

        function createChartData(areaKeys, config, type = 'line') {
            const filteredMetrics = getFilteredMetrics();
            const allDates = new Set();
            areaKeys.forEach(area => {
                Object.keys(filteredMetrics[area] || {}).forEach(date => allDates.add(date));
            });
            const sortedDates = Array.from(allDates).sort();

            const datasets = config.map(metric => {
                const data = sortedDates.map(date => {
                    const areaMetrics = filteredMetrics[metric.area] || {};
                    return areaMetrics[date] ? areaMetrics[date][metric.key] : null;
                });

                return {
                    label: metric.name,
                    data: data,
                    borderColor: metric.color,
                    tension: 0.1,
                    type: type // Permite tipos mistos
                };
            });

            return {
                labels: sortedDates,
                datasets: datasets
            };
        }

        function renderAllCharts() {
            // 1. Inventário e Reversa
            const invRevConfig = [
                { ...metricConfigs['Inventario'][0], area: 'Inventario' }, // backlogInventario
                { ...metricConfigs['Inventario'][1], area: 'Inventario' }, // totalSorting
                { ...metricConfigs['Reversa'][0], area: 'Reversa' }, // desviosExpedicao
                { ...metricConfigs['Reversa'][1], area: 'Reversa' }  // insucessosRecebidos
            ];
            const invRevData = createChartData(['Inventario', 'Reversa'], invRevConfig);
            renderChart('inventoryReverseChart', 'Backlog de Inventário e Processos de Reversa', invRevData);

            // 2. Nível de Serviço
            const slConfig = metricConfigs['NivelDeServico'].map(m => ({ ...m, area: 'NivelDeServico' }));
            const slData = createChartData(['NivelDeServico'], slConfig);
            renderChart('serviceLevelChart', 'Nível de Serviço: Tempo e Acuracidade', slData, 'line', {
                scales: {
                    y: {
                        suggestedMin: 80, // Sugere um mínimo para porcentagens
                        suggestedMax: 100
                    }
                }
            });

            // 3. Logística
            const logConfig = metricConfigs['Logistica'].map(m => ({ ...m, area: 'Logistica' }));
            const logData = createChartData(['Logistica'], logConfig);
            renderChart('logisticsChart', 'Logística: Desvios e Produtividade', logData, 'bar');
        }

        function renderDashboard() {
            renderKPISummary();
            renderAllCharts();
        }

        // --- Funções de Filtro ---

        function applyFilters() {
            activeFilters.startDate = document.getElementById('start-date').value;
            activeFilters.endDate = document.getElementById('end-date').value;
            renderDashboard();
            showMessage('Filtros aplicados com sucesso.');
        }

        function resetFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            activeFilters.startDate = null;
            activeFilters.endDate = null;
            renderDashboard();
            showMessage('Filtros resetados.');
        }

        // --- Funções do Modal ---

        function getMetricInputHTML(key, name, currentValue = '') {
            const isPercentage = name.includes('(%)');
            const placeholder = isPercentage ? 'Ex: 99.5' : 'Apenas números inteiros';
            const type = isPercentage ? 'number' : 'number';
            const step = isPercentage ? '0.01' : '1';

            return `
                <div>
                    <label for="input-${key}" class="block text-sm font-medium text-gray-700">${name}:</label>
                    <input type="${type}" id="input-${key}" data-metric-key="${key}" value="${currentValue}" step="${step}" placeholder="${placeholder}"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                </div>
            `;
        }

        function setupModal() {
            const areaSelect = document.getElementById('input-area');
            const dateInput = document.getElementById('input-date');
            const dynamicFieldsContainer = document.getElementById('dynamic-fields-container');
            const observacoesInput = document.getElementById('input-observacoes');

            // Limpa o modal
            dynamicFieldsContainer.innerHTML = '';
            dateInput.value = '';
            observacoesInput.value = '';

            areaSelect.onchange = () => {
                const area = areaSelect.value;
                dynamicFieldsContainer.innerHTML = '';
                
                if (area && metricConfigs[area]) {
                    metricConfigs[area].forEach(metric => {
                        dynamicFieldsContainer.innerHTML += getMetricInputHTML(metric.key, metric.name);
                    });
                }
            };

            dateInput.onchange = () => {
                const area = areaSelect.value;
                const dateKey = dateInput.value;

                if (area && dateKey && allMetrics[area] && allMetrics[area][dateKey]) {
                    const existingData = allMetrics[area][dateKey];
                    observacoesInput.value = existingData.observacoes || '';

                    // Preenche os campos com dados existentes
                    metricConfigs[area].forEach(metric => {
                        const input = document.getElementById(`input-${metric.key}`);
                        if (input && existingData[metric.key] !== undefined) {
                            input.value = existingData[metric.key];
                        }
                    });
                    showMessage(`Dados para ${area} em ${dateKey} encontrados e carregados.`);
                } else if (area) {
                     // Limpa apenas os campos de métrica se a data for nova
                     metricConfigs[area].forEach(metric => {
                        const input = document.getElementById(`input-${metric.key}`);
                        if (input) input.value = '';
                    });
                    observacoesInput.value = '';
                }
            };
        }

        // --- Início: Listener do Formulário (CORRIGIDO) ---

        document.getElementById('daily-data-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const area = document.getElementById('input-area').value;
            const data = {
                date: document.getElementById('input-date').value,
                observacoes: document.getElementById('input-observacoes').value
            };
            
            if (!area || !data.date) {
                showMessage('Por favor, selecione a Área e a Data.', true);
                return;
            }

            // CORREÇÃO CRÍTICA APLICADA AQUI: Garante que valores vazios ou não-numéricos sejam tratados
            let isValid = true;
            document.querySelectorAll('#dynamic-fields-container input[data-metric-key]').forEach(input => {
                // Remove espaços e substitui vírgula por ponto (para decimais)
                const rawValue = input.value.trim().replace(',', '.'); 
                
                let value;
                if (rawValue === '') {
                    value = 0; // Trata campos vazios como zero
                } else if (input.step === '0.01') {
                    // Trata campos de porcentagem (decimais)
                    value = parseFloat(rawValue);
                } else {
                    // Trata campos de número inteiro
                    value = parseInt(rawValue, 10);
                }

                if (isNaN(value)) {
                    isValid = false;
                    // Opcional: highlight do campo
                    input.style.borderColor = 'red';
                } else {
                    input.style.borderColor = ''; // Remove highlight
                }
                data[input.dataset.metricKey] = value;
            });

            if (!isValid) {
                showMessage('Por favor, insira apenas números válidos (ponto ou vírgula para decimal) nos campos de métricas.', true);
                return;
            }

            saveDataToStorage(area, data);
        });

        // --- Fim: Listener do Formulário ---


        // --- Inicialização ---
        window.onload = () => {
            loadAllMetrics();
            renderDashboard();
            // Configura os listeners de filtro para o estado inicial
            document.getElementById('start-date').value = activeFilters.startDate;
            document.getElementById('end-date').value = activeFilters.endDate;
        };

    </script>

</body>
</html>
